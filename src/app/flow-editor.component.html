<div class="app-container">

    <div class="sidebar">

        <div class="section-header" (click)="toggleActions()">
            <h3>A√ß√µes</h3>
            <button class="toggle-btn">
                {{ showActions ? '‚ñº' : '‚ñ∂' }}
            </button>
        </div>

        <div class="actions-container" *ngIf="showActions">
            <button *ngFor="let tool of tools" (click)="addNode(tool.id, tool.label)" draggable="true"
                (dragstart)="onDragStart($event, tool.id, tool.label)" style="cursor: grab;">
                <span *ngIf="tool.icon" style="margin-right: 5px;">{{ tool.icon }}</span>
                {{ tool.label }}
            </button>
        </div>

        <hr style="border: 0; border-top: 1px solid #eee; margin: 10px 0;">

        <h3 style="margin: 5px 0;; font-size: 12px; text-transform: uppercase;">L√≥gica</h3>

        <button (click)="addNode('if')" draggable="true" (dragstart)="onDragStart($event, 'if', 'IF')"
            style="border-left: 4px solid #faad14; background: #fffbe6; cursor: grab;">
            üîÄ Condi√ß√£o (IF)
        </button>

        <hr style="border: 0; border-top: 1px solid #eee; margin: 10px 0;">

        <button (click)="triggerFileInput()"
            style="margin-top: 5px; border-color: #1890ff; color: #1890ff; background: #e6f7ff;">
            üìÇ Importar Fluxo
        </button>

        <input type="file" id="fileInput" style="display: none;" accept=".json" (change)="onFileSelected($event)">

        <button (click)="clearCanvas()" style="margin-top: 5px; border-color: #ff4d4f; color: #ff4d4f;">
            üóëÔ∏è Limpar Fluxo
        </button>

        <div class="instruction">
            <small>üñ±Ô∏è Arrastar e Conectar</small><br>
            <small>üóëÔ∏è Delete para apagar</small><br>
            <small>‚úèÔ∏è Clique Duplo para Editar</small>
        </div>
    </div>

    <div #container class="graph-container" (dragover)="onDragOver($event)" (drop)="onDrop($event)">
    </div>

    <div class="config-overlay" [class.active]="showConfig" (click)="closeConfig()"></div>

    <div class="config-sidebar" [class.active]="showConfig" [class.maximized]="configMaximized">

        <div class="config-header">
            <h3>Configura√ß√£o</h3>

            <div class="header-actions">

                <button class="icon-btn" (click)="toggleMaximize()"
                    [title]="configMaximized ? 'Restaurar' : 'Maximizar'">
                    <span *ngIf="!configMaximized" style="font-size: 18px;">‚§¢</span>
                    <span *ngIf="configMaximized" style="font-size: 18px;">‚§°</span>
                </button>

                <button class="icon-btn close-variant" (click)="closeConfig()" title="Fechar">√ó</button>
            </div>
        </div>

        <div class="config-body">
            <ng-container [ngSwitch]="editingNode?.getData()?.type">

                <div *ngSwitchCase="'if'">
                    <h4 style="margin-top:0; color:#faad14">Regra Condicional</h4>

                    <div class="form-group">
                        <label>Propriedade:</label>
                        <select [(ngModel)]="selectedProperty" (change)="onPropertyChange()">
                            <option [ngValue]="null" disabled>Selecione...</option>
                            <option *ngFor="let prop of properties" [ngValue]="prop">
                                {{ prop.label }} ({{ prop.type }})
                            </option>
                        </select>
                    </div>

                    <div class="form-group" *ngIf="selectedProperty">
                        <label>Compara√ß√£o:</label>
                        <select [(ngModel)]="selectedOperator">
                            <option value="" disabled>Selecione...</option>
                            <option *ngFor="let op of availableOperators" [value]="op.id">
                                {{ op.label }}
                            </option>
                        </select>
                    </div>

                    <div class="form-group" *ngIf="selectedOperator && selectedProperty?.type !== 'boolean'">
                        <label>Valor:</label>
                        <input *ngIf="selectedProperty?.type === 'number'" type="number" [(ngModel)]="conditionValue">
                        <input *ngIf="selectedProperty?.type === 'string'" type="text" [(ngModel)]="conditionValue">
                        <input *ngIf="selectedProperty?.type === 'date'" type="date" [(ngModel)]="conditionValue">
                    </div>
                </div>

                <div *ngSwitchDefault>

                    <h4 style="margin-top:0; color:#1890ff">
                        {{ editingNode?.getData()?.type | titlecase }}
                    </h4>

                    <div class="form-group">
                        <label>Nome do Passo (Visual):</label>
                        <input type="text" [(ngModel)]="editingNodeLabel" placeholder="Ex: Enviar Email">
                    </div>

                    <div *ngIf="currentSchema; else noSchemaTpl">
                        <hr style="border:0; border-top:1px dashed #eee; margin:15px 0;">

                        <div *ngIf="uiConfigSections.length > 0; else noSchemaTpl">

                            <div *ngFor="let section of uiConfigSections; let i = index" class="accordion-section">

                                <details [open]="i === 0 || section.expanded">
                                    <summary class="accordion-header">
                                        {{ section.title }}
                                        <span class="icon">‚ñº</span>
                                    </summary>

                                    <div class="accordion-content">
                                        <div class="form-group" *ngFor="let field of section.fields">
                                            <label>
                                                {{ field.label }}
                                                <span *ngIf="field.required" style="color:red">*</span>
                                            </label>

                                            <input *ngIf="field.type === 'text'" type="text"
                                                [(ngModel)]="dynamicValues[field.name]"
                                                [placeholder]="field.placeholder || ''">

                                            <input *ngIf="field.type === 'number'" type="number"
                                                [(ngModel)]="dynamicValues[field.name]"
                                                [placeholder]="field.placeholder || ''">

                                            <input *ngIf="field.type === 'date'" type="date"
                                                [(ngModel)]="dynamicValues[field.name]">

                                            <div *ngIf="field.type === 'boolean'"
                                                style="display:flex; align-items:center; gap:10px;">
                                                <input type="checkbox" [(ngModel)]="dynamicValues[field.name]"
                                                    style="width:auto; margin:0;">
                                                <span style="color:#666; font-size:13px;">{{ field.placeholder ||
                                                    'Ativar?' }}</span>
                                            </div>

                                            <textarea *ngIf="field.type === 'textarea'"
                                                [(ngModel)]="dynamicValues[field.name]" rows="4"
                                                [placeholder]="field.placeholder || ''"></textarea>

                                            <select *ngIf="field.type === 'select'"
                                                [(ngModel)]="dynamicValues[field.name]">
                                                <option [ngValue]="undefined" disabled>Selecione...</option>
                                                <option *ngFor="let opt of field.options" [ngValue]="opt.value">{{
                                                    opt.label }}</option>
                                            </select>

                                        </div>
                                    </div>
                                </details>
                            </div>

                        </div>

                        <ng-template #noSchemaTpl>
                        </ng-template>
                    </div>

                    <ng-template #noSchemaTpl>
                        <div
                            style="background:#f9f9f9; padding:15px; border-radius:6px; color:#999; text-align:center; font-style:italic;">
                            Nenhuma configura√ß√£o extra.
                        </div>
                    </ng-template>
                </div>

            </ng-container>
        </div>

        <div class="config-footer">
            <button class="cancel-btn" (click)="closeConfig()">Cancelar</button>
            <button class="save-btn" (click)="saveConfiguration()">Salvar Altera√ß√µes</button>
        </div>
    </div>
</div>